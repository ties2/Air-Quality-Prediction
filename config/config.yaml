# Nested Learning for Continual Air Quality Prediction
# Main Configuration File

# =============================================================================
# Data Configuration
# =============================================================================
data:
  # OpenAQ API settings
  api_key: ${oc.env:OPENAQ_API_KEY}
  base_url: "https://api.openaq.org/v3"
  
  # Target cities for data collection
  cities:
    - Delhi
    - Beijing
    - Los Angeles
    - Mexico City
    - London
  
  # Pollutant parameters to track
  # OpenAQ parameter IDs: pm25=2, pm10=1, no2=5, o3=3, co=4, so2=6
  parameters:
    - pm25
    - pm10
    - no2
    - o3
    - co
    - so2
  
  # Time series settings
  history_window: 168  # 7 days of hourly data (168 hours)
  forecast_horizon: 24  # Predict 24 hours ahead
  resolution: "hourly"  # hourly, daily
  
  # Data quality
  min_coverage: 0.8  # Minimum data completeness (80%)
  max_gap_hours: 6   # Maximum gap to interpolate
  
  # Caching
  cache_enabled: true
  cache_dir: "data/cache"
  cache_ttl: 3600  # 1 hour

# =============================================================================
# Model Configuration
# =============================================================================
model:
  name: "hope_air"
  
  # Base architecture
  input_dim: null  # Auto-calculated from data
  hidden_dim: 256
  output_dim: null  # Auto-calculated from forecast_horizon * n_params
  n_layers: 6
  n_heads: 8
  dropout: 0.1
  
  # Continuum Memory System (CMS)
  cms:
    enabled: true
    n_levels: 3
    frequencies: [0.1, 0.5, 0.9]  # Update rates: fast, medium, slow
    memory_dim: 128
    memory_depth: 2  # Depth of memory MLPs
    use_gating: true
  
  # Self-Modifying Titans
  titans:
    enabled: true
    surprise_threshold: 0.01
    memory_size: 1024
    n_memory_steps: 2  # Memorization steps per sample
  
  # Deep Optimizer (internal to HOPE)
  deep_optimizer:
    type: "deep_momentum_gd"
    momentum_depth: 2
    use_l2_regression: true
  
  # Attention mechanism
  attention:
    type: "linear"  # linear, standard, associative
    causal: true

# =============================================================================
# Training Configuration
# =============================================================================
training:
  # Basic settings
  batch_size: 32
  learning_rate: 1.0e-4
  weight_decay: 1.0e-5
  max_epochs: 100
  gradient_clip: 1.0
  
  # Optimizer (external, for model weights)
  optimizer:
    name: "AdamW"
    betas: [0.9, 0.999]
    eps: 1.0e-8
  
  # Learning rate scheduler
  scheduler:
    name: "cosine_annealing_warm_restarts"
    T_0: 10
    T_mult: 2
    eta_min: 1.0e-6
  
  # Early stopping
  early_stopping:
    enabled: true
    patience: 10
    min_delta: 0.001
    monitor: "val_loss"
  
  # Validation
  val_split: 0.15
  val_frequency: 1  # Validate every N epochs
  
  # Data augmentation for time series
  augmentation:
    enabled: true
    noise_std: 0.01
    time_warp_prob: 0.2
    magnitude_warp_prob: 0.2

# =============================================================================
# Continual Learning Configuration
# =============================================================================
continual:
  enabled: true
  
  # Task definition
  task_duration: "7d"  # New task every 7 days
  n_tasks: 12  # Total number of sequential tasks
  
  # Experience replay
  replay:
    enabled: true
    buffer_size: 1000
    strategy: "reservoir"  # reservoir, fifo, priority
    replay_ratio: 0.3  # Fraction of batch from replay
  
  # Regularization against forgetting
  regularization:
    method: "ewc"  # ewc, lwf, si, none
    lambda_ewc: 5000.0
    n_fisher_samples: 200
  
  # Evaluation
  eval_on_all_tasks: true
  forgetting_threshold: 0.1  # Alert if BWT exceeds this

# =============================================================================
# Evaluation Configuration
# =============================================================================
evaluation:
  metrics:
    - mae
    - rmse
    - mape
    - r2
  
  # Continual learning metrics
  continual_metrics:
    - backward_transfer  # BWT
    - forward_transfer   # FWT
    - average_accuracy   # ACC
    - forgetting_measure # FM
  
  # Per-pollutant evaluation
  per_parameter: true
  
  # Visualization
  save_plots: true
  plot_format: "png"

# =============================================================================
# Logging Configuration
# =============================================================================
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  
  # MLflow
  mlflow:
    enabled: true
    tracking_uri: "mlflow/"
    experiment_name: "nested_air_quality"
  
  # Weights & Biases (optional)
  wandb:
    enabled: false
    project: "nested-air-pollution"
    entity: null
  
  # Console output
  log_interval: 100  # Steps between logs
  progress_bar: true

# =============================================================================
# Infrastructure Configuration
# =============================================================================
infrastructure:
  # Compute
  device: "cuda"  # cuda, cpu, mps
  mixed_precision: true
  num_workers: 4
  pin_memory: true
  
  # Checkpointing
  checkpoint_dir: "models/"
  save_top_k: 3
  save_every_n_epochs: 5
  
  # Random seeds for reproducibility
  seed: 42
  deterministic: true

# =============================================================================
# Deployment Configuration
# =============================================================================
deployment:
  # FastAPI server
  host: "0.0.0.0"
  port: 8000
  
  # Model serving
  model_path: "models/hope_best.pt"
  batch_inference: true
  max_batch_size: 64
  
  # Alert system
  alerts:
    enabled: true
    pm25_threshold: 150  # Unhealthy level
    no2_threshold: 100
    notification_webhook: null
